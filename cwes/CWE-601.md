# Pattern: CWE-601 Open Redirect (Generic)

Captures-first
- From `captures/`, find 3xx responses and extract `Location` headers tied to input parameters (e.g., `next`, `url`, `redirect`).

What to look for
- Sources: attacker-controlled URL/path/query fragments used to build a redirect Location header or HTTP 3xx response.
- Sinks: code that writes `Location:` or constructs 3xx responses (response builders, header setters).

Red flags
- Redirects built from unvalidated user input, even after URL decoding.
- Lack of allowlist for hosts/paths, no scheme/domain checks, no relative‑only enforcement.
 - URL normalization performed after writing headers, or on a different variable than used for `Location`.
 - Accepting scheme-relative `//host` or backslash-prefixed `\host` as external.

High‑level procedure (IDA Pro MCP)
1) From captures, list candidate params and routes; search strings: `Location:`, `HTTP/1.1 30`, `redirect`, `Found`, `Moved`.
2) Xref/decompile redirect builders; identify source of `Location` value; verify transformations and checks.
3) Walk back to dispatcher/handlers to confirm user input influence; annotate with `set_comment`.
4) Rename redirect utilities (`Redirect_Builder`, `Is_Relative_URL`, `Allowlist_Check`), set prototypes for clarity.

Desired fix shape
- Enforce relative-only redirects or strict allowlist of domains/paths.
- Normalize/validate the target before emitting `Location`; strip dangerous schemes (`javascript:`), userinfo, mixed separators.
Reference pseudo-code
```
url = url_decode(param("next"))
if (!is_relative(url) && !is_allowlisted(url)) return 400
loc = normalize(url)
emit_location(loc)
```

Dynamic spot‑checks
- Try `?next=http://attacker/`, `?next=//attacker/`, `?next=\attacker\`, `?next=/ok`, confirm behavior.

Advanced fuzz strategy
- Targets: query params (`next`, `url`, `redirect`, `returnTo`), path segments, fragments.
- Payload families:
  - Absolute URLs: `http://attacker/`, `//attacker/` (scheme-relative), `\attacker\`
  - Mixed/encoded: `http:%2f%2fattacker/`, `/%5c/attacker/`, `%5c%5cattacker/`
  - Userinfo tricks: `http://attacker@trusted/`
  - CRLF/response splitting adjacency: `%0d%0aLocation:%20http://attacker/` (only in safe tests)
- Heuristics:
  - 3xx status with Location header controlled by input
  - Open redirect when Location points to untrusted host/scheme
  - Normalization quirks: double-decoding leading to external Location
- Mitigations to verify:
  - Enforce relative-only redirects or strict allowlists
  - Normalize/validate before emitting Location

MCP action anchors (see `tool-notes/IDA_MCP.md`)
- Tag redirect handlers/builders with `set_comment`; rename allowlist/validator utilities; ensure checks executed before header write.
